# AWS アーキテクチャ設計書（1on1 学習カリキュラム管理システム）

このドキュメントは、1on1 学習カリキュラム管理システムの AWS インフラ設計書です。各 AWS サービスの特徴や知っておくべき知識についても記載しています。

## システム概要

1on1 学習カリキュラム管理システムは、生徒の受講管理、授業スケジュール管理、ビデオ提出とレビュー機能を提供する Web アプリケーションです。

- **フロントエンド**: React
- **バックエンド**: EC2 上で動作するアプリケーションサーバー
- **データベース**: PostgreSQL（RDS）
- **ストレージ**: S3（ビデオファイル保存）

---

## リージョン・アベイラビリティゾーン構成

### リージョン

- **東京リージョン（ap-northeast-1）**を使用

**リージョンについて知っておくべきこと**:

- リージョンは地理的に独立した AWS のサービス提供エリア
- 各リージョンは複数のアベイラビリティゾーン（AZ）で構成される
- リージョン間のデータ転送には料金がかかる
- リージョンごとに利用可能なサービスや価格が異なる場合がある
- データ主権やレイテンシーの要件に応じてリージョンを選択する

### アベイラビリティゾーン（AZ）

- **複数 AZ 構成**で高可用性を実現
- 推奨: ap-northeast-1a と ap-northeast-1c（2 つの AZ を使用）

**AZ について知っておくべきこと**:

- AZ は物理的に独立したデータセンター群
- 各 AZ は低レイテンシーのネットワークで接続されている
- 単一障害点を避けるため、複数 AZ にリソースを分散配置する
- AZ 間のデータ転送には料金がかかる場合がある

---

## ネットワーク構成（VPC・サブネット）

### VPC（Virtual Private Cloud）

- 1 つの VPC を作成
- CIDR ブロック例: `10.0.0.0/16`

**VPC について知っておくべきこと**:

- VPC は AWS 内の仮想ネットワーク環境
- 論理的に独立したネットワーク空間を提供
- デフォルト VPC とカスタム VPC がある
- リージョン内で複数の VPC を作成可能

### サブネット構成（三層構造）

#### 1. WEB 層（パブリックサブネット）

- **用途**: ALB（Application Load Balancer）を配置
- **CIDR 例**: `10.0.1.0/24`（AZ-1a）、`10.0.2.0/24`（AZ-1c）
- **特徴**: インターネットゲートウェイ（IGW）経由でインターネットと通信可能

#### 2. APP 層（プライベートサブネット）

- **用途**: EC2 インスタンス（アプリケーションサーバー）を配置
- **CIDR 例**: `10.0.11.0/24`（AZ-1a）、`10.0.12.0/24`（AZ-1c）
- **特徴**: インターネットへの直接アクセス不可。NAT ゲートウェイ経由でアウトバウンド通信

#### 3. DB 層（プライベートサブネット）

- **用途**: RDS（PostgreSQL）を配置
- **CIDR 例**: `10.0.21.0/24`（AZ-1a）、`10.0.22.0/24`（AZ-1c）
- **特徴**: 最も制限されたサブネット。インターネットアクセス不可

**サブネットについて知っておくべきこと**:

- サブネットは VPC 内の IP アドレス範囲
- パブリックサブネット: IGW へのルートがある
- プライベートサブネット: IGW へのルートがない（または NAT ゲートウェイ経由）
- 各サブネットは 1 つの AZ に属する
- 複数 AZ にまたがるサブネットは作成できない

### ルートテーブル

#### WEB 層ルートテーブル

| 送信先      | ターゲット                              |
| ----------- | --------------------------------------- |
| 10.0.0.0/16 | local                                   |
| 0.0.0.0/0   | igw-xxxxx（インターネットゲートウェイ） |

#### APP 層ルートテーブル

| 送信先      | ターゲット                    |
| ----------- | ----------------------------- |
| 10.0.0.0/16 | local                         |
| 0.0.0.0/0   | nat-xxxxx（NAT ゲートウェイ） |

#### DB 層ルートテーブル

| 送信先      | ターゲット |
| ----------- | ---------- |
| 10.0.0.0/16 | local      |

**ルートテーブルについて知っておくべきこと**:

- パケットの転送先を決定する
- 各サブネットにはルートテーブルを関連付ける
- より具体的なルートが優先される
- デフォルトでは VPC 内通信（local）のみ

---

## インターネット接続

### インターネットゲートウェイ（IGW）

- **用途**: WAN からのインバウンドトラフィックを受け付ける
- **配置**: VPC にアタッチ
- **通信フロー**: インターネット → IGW → ALB（WEB 層）

**IGW について知っておくべきこと**:

- VPC とインターネットを接続するマネージドサービス
- 高可用性・スケーラブル（AWS が管理）
- パブリック IP アドレスが必要
- インバウンド・アウトバウンド両方向の通信をサポート

### NAT ゲートウェイ

- **用途**: EC2 インスタンスが WAN にアクセスする際のアウトバウンド通信
- **配置**: WEB 層のパブリックサブネットに配置（各 AZ に 1 つ推奨）
- **通信フロー**: EC2（APP 層） → NAT ゲートウェイ → IGW → インターネット

**NAT ゲートウェイについて知っておくべきこと**:

- プライベートサブネットからインターネットへのアウトバウンド通信を可能にする
- インバウンド通信は不可（セキュリティ向上）
- 高可用性のため、各 AZ に配置することを推奨
- 使用量に応じた料金がかかる（時間あたり + データ転送量）

---

## アプリケーション層

### Application Load Balancer（ALB）

- **配置**: WEB 層のパブリックサブネット（複数 AZ に分散）
- **用途**: クライアントからのリクエストを EC2 インスタンスに分散
- **リスナー**: HTTPS（443）と HTTP（80）をサポート

**ALB について知っておくべきこと**:

- レイヤー 7（HTTP/HTTPS）のロードバランサー
- パスベースルーティング、ホストベースルーティングが可能
- ヘルスチェック機能で異常なインスタンスを自動的に切り離す
- SSL/TLS 終端処理が可能（ACM と連携）
- ターゲットグループに EC2 インスタンスを登録

### Auto Scaling

- **用途**: EC2 インスタンスの自動スケーリング
- **構成**:
  - **起動テンプレート**: EC2 インスタンスの設定を定義
  - **Auto Scaling グループ**: インスタンスの最小・最大・希望数を設定
  - **スケーリングポリシー**: CPU 使用率やリクエスト数に基づいて自動スケール

**Auto Scaling について知っておくべきこと**:

- **スケールアウト**: 負荷が高いときにインスタンスを追加
- **スケールイン**: 負荷が低いときにインスタンスを削減
- **ターゲット追跡スケーリング**: メトリクス（例: CPU 使用率 70%）を維持
- **ステップスケーリング**: 閾値を超えた段階に応じてスケール
- 複数 AZ に分散配置することで高可用性を実現

### EC2 インスタンス

- **配置**: APP 層のプライベートサブネット（複数 AZ）
- **用途**: アプリケーションサーバーとして動作
- **構成**: Auto Scaling グループで管理

**EC2 について知っておくべきこと**:

- 仮想サーバーを提供するサービス
- **インスタンスタイプ**: CPU、メモリ、ネットワーク性能が異なる
- **AMI（Amazon Machine Image）**: インスタンスのテンプレート
- **EBS（Elastic Block Store）**: ブロックストレージ（OS やアプリケーション用）
- **セキュリティグループ**: ファイアウォール機能
- **ユーザーデータ**: 起動時にスクリプトを実行可能

---

## データベース層

### RDS（Relational Database Service）

- **エンジン**: PostgreSQL
- **構成**: マルチ AZ 構成
- **配置**: DB 層のプライベートサブネット（複数 AZ）

**RDS について知っておくべきこと**:

- **マルチ AZ 構成**: プライマリ DB とスタンバイ DB を異なる AZ に配置
  - 自動フェイルオーバー（約 60-120 秒）
  - 同期レプリケーション
  - 高可用性を実現
- **バックアップ**: 自動バックアップ（最大 35 日間保持）
- **スナップショット**: 手動バックアップ（任意のタイミングで作成）
- **セキュリティグループ**: 特定のサブネットからのアクセスのみ許可

### データベース構成

- **プライマリ DB**: AZ-1a に配置
- **スタンバイ DB**: AZ-1c に配置（マルチ AZ）

---

## ストレージ

### S3（Simple Storage Service）

- **用途**: ビデオファイルの保存
- **構成**:
  - プライベートバケットとして作成
  - アプリケーションからのみアクセス可能
- **データ連携**: RDS の `video_submissions` テーブルに S3 の URL を格納

**S3 について知っておくべきこと**:

- **オブジェクトストレージ**: ファイルをオブジェクトとして保存
- **バケット**: オブジェクトを格納するコンテナ（リージョン内で一意の名前）
- **ストレージクラス**:
  - **Standard**: 頻繁にアクセスするデータ
  - **Standard-IA**: アクセス頻度が低いデータ（低コスト）
  - **Glacier**: アーカイブ用（非常に低コスト、取り出しに時間がかかる）
- **バージョニング**: オブジェクトの変更履歴を保持
- **ライフサイクルポリシー**: 自動的にストレージクラスを変更
- **アクセス制御**: IAM ポリシー、バケットポリシーで制御
- **プリサインド URL**: 一時的なアクセス URL を生成可能

---

## セキュリティグループ（SG）

### ALB のセキュリティグループ

| タイプ         | プロトコル | ポート | ソース    |
| -------------- | ---------- | ------ | --------- |
| インバウンド   | HTTPS      | 443    | 0.0.0.0/0 |
| インバウンド   | HTTP       | 80     | 0.0.0.0/0 |
| アウトバウンド | All        | All    | 0.0.0.0/0 |

### EC2 のセキュリティグループ

| タイプ         | プロトコル | ポート                     | ソース                                     |
| -------------- | ---------- | -------------------------- | ------------------------------------------ |
| インバウンド   | TCP        | 8080（アプリケーション用） | ALB のセキュリティグループ                 |
| アウトバウンド | HTTPS      | 443                        | 0.0.0.0/0（S3 やパッケージダウンロード用） |
| アウトバウンド | HTTP       | 80                         | 0.0.0.0/0（パッケージダウンロード用）      |
| アウトバウンド | TCP        | 5432                       | RDS のセキュリティグループ                 |

### RDS のセキュリティグループ

| タイプ         | プロトコル | ポート             | ソース                     |
| -------------- | ---------- | ------------------ | -------------------------- |
| インバウンド   | TCP        | 5432（PostgreSQL） | EC2 のセキュリティグループ |
| アウトバウンド | All        | All                | 0.0.0.0/0                  |

**セキュリティグループについて知っておくべきこと**:

- **ステートフルファイアウォール**: インバウンドルールを設定すると、アウトバウンドは自動的に許可
- **デフォルト**: すべてのインバウンドを拒否、すべてのアウトバウンドを許可
- **ルールの優先順位**: すべてのルールが評価される（最初にマッチしたものが適用）
- **セキュリティグループ参照**: 他のセキュリティグループをソース/ターゲットに指定可能
- **ネットワーク ACL との違い**: SG はインスタンスレベル、NACL はサブネットレベル

---

## 通信フロー

### 1. クライアントからアプリケーションへのアクセス

```
インターネット
  ↓
IGW
  ↓
ALB（WEB 層パブリックサブネット）
  ↓
EC2 インスタンス（APP 層プライベートサブネット）
  ↓
RDS（DB 層プライベートサブネット）
```

### 2. EC2 からインターネットへのアクセス（パッケージダウンロードなど）

```
EC2 インスタンス（APP 層）
  ↓
NAT ゲートウェイ（WEB 層パブリックサブネット）
  ↓
IGW
  ↓
インターネット
```

### 3. EC2 から S3 へのアクセス（ビデオファイルのアップロード/ダウンロード）

```
EC2 インスタンス（APP 層）
  ↓
VPC エンドポイント（推奨）または NAT ゲートウェイ経由
  ↓
S3
```

**VPC エンドポイントについて知っておくべきこと**:

- VPC 内から AWS サービス（S3、DynamoDB など）にプライベート接続
- インターネットゲートウェイや NAT ゲートウェイを経由しない
- データ転送料金が削減できる
- セキュリティが向上（インターネット経由しない）

---

## 高可用性・障害対策

### マルチ AZ 構成

- **ALB**: 複数 AZ に分散配置
- **EC2**: Auto Scaling で複数 AZ に分散
- **RDS**: マルチ AZ 構成で自動フェイルオーバー

### バックアップ戦略

- **RDS**: 自動バックアップ（毎日、保持期間 7-35 日）
- **S3**: バージョニングとライフサイクルポリシーでバックアップ
- **EC2**: AMI スナップショットを定期的に作成

### モニタリング

- **CloudWatch**: メトリクス監視（CPU、メモリ、ネットワークなど）
- **ALB アクセスログ**: リクエストログを S3 に保存
- **RDS イベント**: フェイルオーバーなどのイベント通知

---

## コスト最適化のポイント

1. **NAT ゲートウェイ**: 使用量に応じた料金がかかるため、VPC エンドポイントの利用を検討
2. **EC2**: Auto Scaling で需要に応じてスケールイン/アウト
3. **S3**: ライフサイクルポリシーで古いビデオファイルを低コストストレージクラスに移動
4. **リザーブドインスタンス**: 長期利用する EC2 や RDS はリザーブドインスタンスで割引

---

## セキュリティのベストプラクティス

1. **最小権限の原則**: セキュリティグループは必要最小限のポートのみ開放
2. **プライベートサブネット**: アプリケーションサーバーと DB はプライベートサブネットに配置
3. **暗号化**:
   - **転送中の暗号化**: HTTPS（ALB で SSL/TLS 終端）
   - **保存時の暗号化**: RDS の暗号化、S3 のサーバーサイド暗号化
4. **IAM ロール**: EC2 インスタンスに IAM ロールを割り当て、S3 へのアクセスを制御
5. **セキュリティグループ参照**: IP アドレスではなく、セキュリティグループ ID で通信を許可

---

## まとめ

このアーキテクチャでは、以下の AWS サービスの特徴を活用しています：

- **VPC**: 論理的に独立したネットワーク環境
- **サブネット**: 三層構造でセキュリティを確保
- **ALB**: トラフィックの分散とヘルスチェック
- **Auto Scaling**: 需要に応じた自動スケーリング
- **RDS マルチ AZ**: 高可用性と自動フェイルオーバー
- **S3**: スケーラブルなオブジェクトストレージ
- **NAT ゲートウェイ**: プライベートサブネットからのアウトバウンド通信

各サービスを適切に組み合わせることで、セキュアでスケーラブルなシステムを構築できます。
