# データベーステーブル設計と正規化の基礎

## なぜデータベースが必要なのか？

### データ管理の課題

私たちは日常的に大量のデータを扱います。例えば、1on1 学習管理システムでは：

- 生徒の情報（名前、メールアドレス、登録日など）
- コースの情報（タイトル、説明、月額料金など）
- 受講登録の情報（どの生徒がどのコースを受講しているか）
- 授業のスケジュール
- ビデオ提出とレビュー

これらのデータを**効率的に、正確に、安全に**管理する必要があります。

### データベースが解決する問題

1. **データの整合性（Integrity）**

   - 同じデータが複数箇所に存在すると、更新漏れや不整合が発生する
   - データベースは「1 つの真実の源（Single Source of Truth）」を提供する

2. **同時アクセス制御（Concurrency Control）**

   - 複数のユーザーが同時にデータを更新しても、矛盾が発生しない
   - トランザクション機能により、データの一貫性を保証

3. **効率的な検索・集計**

   - 大量のデータから特定の条件で素早く検索できる
   - 複雑な集計処理を高速に実行できる

4. **データの永続性（Persistence）**

   - システムが停止してもデータが失われない
   - バックアップとリカバリの仕組みが整っている

5. **セキュリティ**

   - ユーザーごとにアクセス権限を設定できる
   - データの暗号化や監査ログの記録が可能

6. **リレーションシップの管理（Relationship Management）**
   - テーブル間の関係を外部キー制約により自動的に管理できる
   - スプレッドシートでは、関連するデータを別シートに分けると、手動で関連付けを管理する必要がある
   - データベースでは、外部キー制約により、参照整合性が自動的に保証される

---

## リレーショナルデータベース（RDB）の基本思想

### リレーショナルモデルの 3 つの基本概念

#### 1. テーブル（Table / 関係 / Relation）

データを**行（Row / タプル）**と**列（Column / 属性）**の 2 次元表で表現します。

```
students テーブル:
+------------+--------------+---------------------------+---------------------+
| student_id | name         | email                     | enrollment_date     |
+------------+--------------+---------------------------+---------------------+
| 101        | 田中 一郎     | ichiro.tanaka@example.com | 2024-01-05 09:00:00 |
| 102        | 高橋 美咲     | misaki.takahashi@...      | 2024-01-10 10:30:00 |
+------------+--------------+---------------------------+---------------------+
```

#### 2. 主キー（Primary Key）

各行を一意に識別する列（または列の組み合わせ）です。

- `students`テーブル: `student_id`が主キー
- `courses`テーブル: `course_id`が主キー

#### 3. 外部キー（Foreign Key）

他のテーブルの主キーを参照する列です。これにより、テーブル間の関係を表現します。

- `enrollments`テーブルの`student_id`は、`students`テーブルの`student_id`を参照
- `enrollments`テーブルの`course_id`は、`courses`テーブルの`course_id`を参照

### RDB の設計原則

#### 1. 正規化（Normalization）

データの重複を排除し、整合性を保つための設計手法。後述します。

#### 2. ACID 特性

- **Atomicity（原子性）**: トランザクションは全て実行されるか、全て実行されないかのどちらか
- **Consistency（一貫性）**: データベースの整合性制約が常に満たされる
- **Isolation（独立性）**: 同時実行されるトランザクションが互いに影響しない
- **Durability（永続性）**: コミットされた変更は失われない

---

## 正規化とは何か？なぜ必要なのか？

### 正規化の目的

正規化の基本原則は「**1 fact in 1 place（1 つの事実は 1 箇所にのみ保存）**」です。これは、同じデータを複数箇所に保存せず、1 箇所にのみ保存することを意味します。この原則に従うことで、データの整合性が保たれ、更新漏れや不整合を防ぐことができます。

1. **データの重複を排除する**

   - 同じデータを複数箇所に保存しない（1 fact in 1 place の原則）
   - ストレージの節約と更新漏れの防止

2. **データの整合性を保つ**

   - 矛盾したデータが存在しないようにする
   - 更新異常、挿入異常、削除異常を防ぐ

3. **柔軟な検索・集計を可能にする**
   - データが整理されているため、効率的なクエリが可能

### 正規化されていないテーブルの問題

#### 例：正規化されていない「受講管理」テーブル

```
enrollments_bad テーブル（正規化されていない）:
+----+--------+------------------+----------------+----+------------------+----------+---------------------+
| id | 生徒名 | メールアドレス    | 登録日         | コース名          | 月額料金 | 受講登録日          |
+----+--------+------------------+----------------+----+------------------+----------+---------------------+
| 1  | 田中一郎 | ichiro@...     | 2024-01-05     | 英会話基礎コース  | 15000    | 2024-01-05 09:15:00 |
| 2  | 田中一郎 | ichiro@...     | 2024-01-05     | 英会話中級コース  | 20000    | 2024-01-20 10:00:00 |
| 3  | 高橋美咲 | misaki@...     | 2024-01-10     | 英会話基礎コース  | 15000    | 2024-01-10 10:45:00 |
+----+--------+------------------+----------------+----+------------------+----------+---------------------+
```

#### 問題 1：更新異常（Update Anomaly）

田中一郎のメールアドレスが変更された場合：

- 複数行を更新する必要がある
- 更新漏れが発生すると、データが矛盾する

```
| 1  | 田中一郎 | ichiro.new@... | ... | 英会話基礎コース | ... |
| 2  | 田中一郎 | ichiro@...     | ... | 英会話中級コース | ... |  ← 更新漏れ！
```

#### 問題 2：挿入異常（Insertion Anomaly）

新しいコース「TOEIC 対策コース」を追加したいが、まだ受講者がいない場合：

- 受講者がいないとコース情報を登録できない（または、ダミーの受講者データが必要）

#### 問題 3：削除異常（Deletion Anomaly）

高橋美咲が唯一の受講者だったコースを削除すると：

- コース情報も一緒に失われてしまう

#### 問題 4：データの重複

- 田中一郎の情報が 2 行に重複している
- 英会話基礎コースの情報が複数行に重複している
- ストレージの無駄と、更新時のリスク

### 正規化の解決策

正規化により、データを適切なテーブルに分割します：

```
students テーブル:
+------------+--------------+---------------------------+
| student_id | name         | email                     |
+------------+--------------+---------------------------+
| 101        | 田中 一郎     | ichiro.tanaka@example.com |
| 102        | 高橋 美咲     | misaki.takahashi@example.com |
+------------+--------------+---------------------------+

courses テーブル:
+-----------+------------------+----------+
| course_id | title            | monthly_price |
+-----------+------------------+----------+
| 201       | 英会話基礎コース  | 15000    |
| 202       | 英会話中級コース  | 20000    |
+-----------+------------------+----------+

enrollments テーブル:
+---------------+------------+-----------+
| enrollment_id | student_id | course_id |
+---------------+------------+-----------+
| 301           | 101        | 201       |
| 302           | 101        | 202       |
| 303           | 102        | 201       |
+---------------+------------+-----------+
```

**メリット：**

- 生徒情報は 1 箇所にのみ存在 → 更新が 1 回で済む
- コース情報は 1 箇所にのみ存在 → 更新が 1 回で済む
- 受講者がいなくてもコースを登録できる
- 受講登録を削除しても、生徒情報やコース情報は残る

---

## 実践：正規化のステップ

正規化は通常、第 1 正規形から第 3 正規形（さらに BCNF、第 4 正規形、第 5 正規形）まで段階的に進めます。

### 第 1 正規形（1NF: First Normal Form）

**ルール：各セルには 1 つの値のみが入る**

#### 正規化前（1NF 違反）

```
students_bad:
+----+--------+------------------+---------------------------+
| id | name   | email            | courses                   |
+----+--------+------------------+---------------------------+
| 1  | 田中一郎 | ichiro@...     | 英会話基礎, 英会話中級    |  ← 複数の値
+----+--------+------------------+---------------------------+
```

#### 正規化後（1NF）

```
students:
+----+--------+------------------+
| id | name   | email            |
+----+--------+------------------+
| 1  | 田中一郎 | ichiro@...     |
| 2  | 高橋美咲 | misaki@...       |
+----+--------+------------------+

enrollments:
+----+------------+-----------+
| id | student_id | course_id |
+----+------------+-----------+
| 1  | 1          | 201       |
| 2  | 1          | 202       |
| 3  | 2          | 201       |
+----+------------+-----------+
```

### 第 2 正規形（2NF: Second Normal Form）

**ルール：1NF であり、かつ部分関数従属がない**

**部分関数従属とは：** 主キーの一部だけで決定できる非キー属性があること

#### 正規化前（2NF 違反の例）

```
enrollments_bad:
+------------+-----------+------------------+----------+
| student_id | course_id | course_title     | monthly_price |
+------------+-----------+------------------+----------+
| 101        | 201       | 英会話基礎コース | 15000    |
| 101        | 202       | 英会話中級コース | 20000    |
| 102        | 201       | 英会話基礎コース | 15000    |  ← 重複
+------------+-----------+------------------+----------+
```

**主キー：** `(student_id, course_id)` の複合キー

**問題：**

- `course_title`と`monthly_price`は`course_id`だけで決まる（`course_id` → course_title, monthly_price`）
- 主キーは`(student_id, course_id)`だが、`course_title`は`course_id`（主キーの一部）だけで決まる → 部分関数従属

#### 正規化後（2NF）

```
enrollments:
+---------------+------------+-----------+
| enrollment_id | student_id | course_id |
+---------------+------------+-----------+
| 301           | 101        | 201       |
| 302           | 101        | 202       |
| 303           | 102        | 201       |
+---------------+------------+-----------+

courses:
+-----------+------------------+----------+
| course_id | title            | monthly_price |
+-----------+------------------+----------+
| 201       | 英会話基礎コース  | 15000    |
| 202       | 英会話中級コース  | 20000    |
+-----------+------------------+----------+
```

**説明：** `course_title`と`monthly_price`を`courses`テーブルに分離しました。正規化前は`(student_id, course_id)`が複合主キーで、`course_title`が主キーの一部（`course_id`）だけで決まっていましたが、正規化後はコース情報を別テーブルに分離することで部分関数従属が解消されました。

**注：** 正規化後の`enrollments`テーブルでは、`enrollment_id`を主キーとしていますが、`(student_id, course_id)`を複合主キーとしても構いません。`enrollment_id`は、同じ生徒が同じコースを複数回受講する可能性がある場合や、他のテーブルからの参照を容易にするために使用されることがあります。

### 第 3 正規形（3NF: Third Normal Form）

**ルール：2NF であり、かつ推移的関数従属がない**

**推移的関数従属とは：** 非キー属性が別の非キー属性によって決定されること

#### 正規化前（3NF 違反の例）

```
courses_bad:
+-----------+------------------+----------+-----------+------------------+
| course_id | title            | monthly_price | category_id | category_name |
+-----------+------------------+----------+-----------+------------------+
| 201       | 英会話基礎コース  | 15000    | 1          | 基礎コース       |
| 202       | 英会話中級コース  | 20000    | 2          | 中級コース       |
+-----------+------------------+----------+-----------+------------------+
```

**主キー：** `course_id`

**問題：**

- `category_name`は`category_id`によって決まる（`category_id → category_name`）
- `course_id`が主キーで、`category_id`は非キー属性、`category_name`も非キー属性
- `course_id → category_id → category_name` という推移的関数従属が発生

#### 正規化後（3NF）

```
courses:
+-----------+------------------+----------+-----------+
| course_id | title            | monthly_price | category_id |
+-----------+------------------+----------+-----------+
| 201       | 英会話基礎コース  | 15000    | 1          |
| 202       | 英会話中級コース  | 20000    | 2          |
+-----------+------------------+----------+-----------+

categories:
+-------------+------------+
| category_id | name       |
+-------------+------------+
| 1           | 基礎コース |
| 2           | 中級コース |
+-------------+------------+
```

### 正規化のまとめ

| 正規形 | 要件                       | 解決する問題           |
| ------ | -------------------------- | ---------------------- |
| 1NF    | 各セルに 1 つの値のみ      | 複数値の混在           |
| 2NF    | 1NF + 部分関数従属の排除   | 主キーの一部による決定 |
| 3NF    | 2NF + 推移的関数従属の排除 | 非キー属性間の依存関係 |

**注意：** 正規化は過度に行うと、クエリが複雑になる場合があります。実務では、パフォーマンスと整合性のバランスを取ることが重要です。

---

## 設計の実例：1on1 学習管理システム

### システムの要件

1. 複数の生徒が複数のコースを受講できる（多対多の関係）
2. 1 つの受講登録に対して複数回の授業が行われる（1 対多の関係）
3. 1 つの授業に対して複数のビデオ提出が可能（1 対多の関係）
4. 1 つのビデオ提出に対して 1 つのレビューが存在する（1 対 1 の関係）

### ER 図（Entity Relationship Diagram）

```
students (1) ────< (N) enrollments (N) >─── (1) courses
                              |
                              | (1)
                              |
                              v (N)
                           lessons
                              |
                              | (1)
                              |
                              v (N)
                    video_submissions
                              |
                              | (1)
                              |
                              v (1)
                           reviews
```

### テーブル設計の詳細

#### 1. students テーブル

```sql
CREATE TABLE students (
  student_id INT PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  email VARCHAR(200) NOT NULL UNIQUE,
  enrollment_date TIMESTAMP NOT NULL
);
```

**設計のポイント：**

- `student_id`を主キーとして、生徒を一意に識別
- `email`に UNIQUE 制約を設定し、重複を防止
- 正規化により、生徒情報は 1 箇所にのみ存在

#### 2. courses テーブル

```sql
CREATE TABLE courses (
  course_id INT PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  monthly_price DECIMAL(10,2) NOT NULL,
  created_at TIMESTAMP NOT NULL
);
```

**設計のポイント：**

- コース情報を独立したテーブルに分離
- 受講者がいなくてもコースを登録できる

#### 3. enrollments テーブル（中間テーブル）

```sql
CREATE TABLE enrollments (
  enrollment_id INT PRIMARY KEY,
  student_id INT NOT NULL,
  course_id INT NOT NULL,
  enrolled_at TIMESTAMP NOT NULL,
  status VARCHAR(20) NOT NULL
);
```

**設計のポイント：**

- 生徒とコースの**多対多の関係**を表現
- `student_id`と`course_id`は外部キー（実際の DDL では外部キー制約を追加推奨）
- `enrollment_id`を主キーとすることで、同じ生徒が同じコースを複数回受講する可能性にも対応

**多対多の関係の表現方法：**

- 直接的な多対多は表現できないため、中間テーブル（結合テーブル）を作成
- これにより、1 人の生徒が複数のコースを受講でき、1 つのコースに複数の生徒が登録できる

#### 4. lessons テーブル

```sql
CREATE TABLE lessons (
  lesson_id INT PRIMARY KEY,
  enrollment_id INT NOT NULL,
  scheduled_at TIMESTAMP NOT NULL,
  duration_minutes INT NOT NULL,
  status VARCHAR(20) NOT NULL,
  notes TEXT
);
```

**設計のポイント：**

- 1 つの受講登録（`enrollment_id`）に対して複数の授業（`lesson_id`）が存在
- **1 対多の関係**を表現
- `enrollment_id`は外部キー

#### 5. video_submissions テーブル

```sql
CREATE TABLE video_submissions (
  submission_id INT PRIMARY KEY,
  lesson_id INT NOT NULL,
  title VARCHAR(200) NOT NULL,
  video_url VARCHAR(500),
  submitted_at TIMESTAMP NOT NULL,
  status VARCHAR(20) NOT NULL
);
```

\*\*設計のポイント：

- 1 つの授業（`lesson_id`）に対して複数のビデオ提出が可能
- **1 対多の関係**を表現

#### 6. reviews テーブル

```sql
CREATE TABLE reviews (
  review_id INT PRIMARY KEY,
  submission_id INT NOT NULL,
  rating INT,
  feedback TEXT,
  reviewed_at TIMESTAMP NOT NULL
);
```

**設計のポイント：**

- 1 つのビデオ提出（`submission_id`）に対して 1 つのレビュー
- **1 対 1 の関係**を表現（実際には 1 対 0 または 1 対 1）

### 外部キー制約の追加（推奨）

実際の運用では、以下のような外部キー制約を追加することを推奨します：

```sql
ALTER TABLE enrollments
  ADD CONSTRAINT fk_enrollments_student
  FOREIGN KEY (student_id) REFERENCES students(student_id);

ALTER TABLE enrollments
  ADD CONSTRAINT fk_enrollments_course
  FOREIGN KEY (course_id) REFERENCES courses(course_id);

ALTER TABLE lessons
  ADD CONSTRAINT fk_lessons_enrollment
  FOREIGN KEY (enrollment_id) REFERENCES enrollments(enrollment_id);

ALTER TABLE video_submissions
  ADD CONSTRAINT fk_video_submissions_lesson
  FOREIGN KEY (lesson_id) REFERENCES lessons(lesson_id);

ALTER TABLE reviews
  ADD CONSTRAINT fk_reviews_submission
  FOREIGN KEY (submission_id) REFERENCES video_submissions(submission_id);
```

**外部キー制約のメリット：**

- 存在しない生徒 ID やコース ID を参照できなくなる（参照整合性）
- 生徒を削除する際、関連する受講登録がある場合はエラーになる（データの保護）

### 正規化の確認

この設計が正規化されているか確認しましょう：

#### 1NF（第 1 正規形）✓

- 各セルに 1 つの値のみが入っている

#### 2NF（第 2 正規形）✓

- すべてのテーブルで、非キー属性は主キー全体に完全関数従属している
- 例：`enrollments`テーブルでは、`enrolled_at`や`status`は`enrollment_id`（主キー）全体によって決まる

#### 3NF（第 3 正規形）✓

- 推移的関数従属がない
- 例：`courses`テーブルの`monthly_price`と`title`は、どちらも`course_id`によって決まり、互いに依存関係がない

### 設計のメリット

1. **データの整合性**

   - 生徒情報は`students`テーブルに 1 箇所のみ
   - コース情報は`courses`テーブルに 1 箇所のみ
   - 更新が 1 回で済む

2. **柔軟な拡張**

   - 新しいコースを追加する際、受講者がいなくても登録できる
   - 新しい属性（例：コースのカテゴリ）を追加しやすい

3. **効率的な検索**

   - インデックスを適切に設定することで、高速な検索が可能
   - JOIN を使った複雑な集計も効率的

4. **スケーラビリティ**
   - データが増えても、パフォーマンスが維持される
   - 適切なインデックス設計により、大規模データにも対応可能

---

## まとめ

### データベースを使う理由

1. **データの整合性を保つ** - 1 つの真実の源
2. **同時アクセスを安全に処理** - トランザクション機能
3. **効率的な検索・集計** - インデックスとクエリ最適化
4. **データの永続性** - バックアップとリカバリ
5. **セキュリティ** - アクセス制御と監査

### スプレッドシートではだめな理由

1. **データの重複と不整合** - 更新漏れのリスク
2. **同時編集の制約** - 競合の発生
3. **データ量の制限** - 大規模データに対応できない
4. **複雑な検索・集計の困難さ** - SQL の柔軟性がない
5. **リレーションシップの管理が困難** - 外部キー制約がない

### 正規化の重要性

1. **データの重複を排除** - ストレージの節約と更新漏れの防止
2. **データの整合性を保つ** - 更新異常、挿入異常、削除異常を防ぐ
3. **柔軟な検索・集計を可能にする** - 効率的なクエリ

### 設計のポイント

1. **適切なテーブル分割** - 正規化により、データを適切なテーブルに分離
2. **主キーと外部キーの設計** - テーブル間の関係を明確に
3. **制約の設定** - UNIQUE、NOT NULL、外部キー制約により整合性を保証
4. **バランスの取れた設計** - 過度な正規化は避け、実用性を重視

---

## 演習問題

### 問題 1：正規化の理解

以下のテーブルを正規化してください。

```
orders_bad:
+----------+--------+------------------+--------+------------------+----------+
| order_id | 顧客名 | 顧客メール       | 商品名 | 商品カテゴリ     | 価格     |
+----------+--------+------------------+--------+------------------+----------+
| 1        | 田中   | tanaka@...       | ノート | 文房具           | 100      |
| 2        | 田中   | tanaka@...       | ペン   | 文房具           | 200      |
| 3        | 佐藤   | sato@...         | ノート | 文房具           | 100      |
+----------+--------+------------------+--------+------------------+----------+
```
